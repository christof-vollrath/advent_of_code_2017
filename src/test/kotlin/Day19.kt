import org.amshove.kluent.`should be less or equal to`
import org.amshove.kluent.`should equal`
import org.jetbrains.spek.api.Spek
import org.jetbrains.spek.api.dsl.*
import kotlin.coroutines.experimental.buildSequence

/*
--- Day 19: A Series of Tubes ---

Somehow, a network packet got lost and ended up here.
It's trying to follow a routing diagram (your puzzle input), but it's confused about where to go.

Its starting point is just off the top of the diagram.
Lines (drawn with |, -, and +) show the path it needs to take,
starting by going down onto the only line connected to the top of the diagram.
It needs to follow this path until it reaches the end (located somewhere within the diagram) and stop there.

Sometimes, the lines cross over each other;
in these cases, it needs to continue going the same direction,
and only turn left or right when there's no other option.
In addition, someone has left letters on the line;
these also don't change its direction, but it can use them to keep track of where it's been.

For example:

     |
     |  +--+
     A  |  C
 F---|----E|--+
     |  |  |  D
     +B-+  +--+

Given this diagram, the packet needs to take the following path:

Starting at the only line touching the top of the diagram,
it must go down, pass through A, and continue onward to the first +.
Travel right, up, and right, passing through B in the process.
Continue down (collecting C), right, and up (collecting D).
Finally, go all the way left through E and stopping at F.
Following the path to the end, the letters it sees on its path are ABCDEF.

The little packet looks up at you, hoping you can help it find the way.
What letters will it see (in the order it would see them) if it follows the path?
(The routing diagram is very wide; make sure you view it without line wrapping.)

Your puzzle answer was PBAZYFMHT.


 */

class Day19Spec : Spek({
    describe("Tubes") {
        on("example") {
            it("should fallow the right path") {
                fallowPath(day19ExampleInput).joinToString("") `should equal` "ABCDEF"
            }
        }
        on("shortest path") {
            val input = """
 A
"""
            it("should find the letter") {
                fallowPath(input).joinToString("") `should equal` "A"
            }
        }
        on("simple path") {
            val input = """
 |
 A
"""
            it("should find the letter") {
                fallowPath(input).joinToString("") `should equal` "A"
            }
        }
    }
    describe("parse tubes") {
        on("example") {
            it("should be parsed correctly") {
                val result = parseTubes(day19ExampleInput)
                result.size `should equal` 6
                result.forEach { it.length `should be less or equal to` 15 }
                (listOf("") + result.toList() + listOf("")).joinToString("\n") `should equal` day19ExampleInput
            }
        }
    }
    describe("find starting point ") {
        on("parsed example") {
            val example = parseTubes(day19ExampleInput)
            it("should find the correct start") {
                findStartPoint(example) `should equal` Pair(5, 0)
            }
        }
    }
    describe("exercise day 19 ") {
        on("find path") {
            val result = fallowPath(day19Input).joinToString("")
            println(result)
        }

    }
})

fun fallowPath(input: String) = fallowPath(parseTubes(input))
fun fallowPath(tubes: Array<String>) = fallowPath(tubes, findStartPoint(tubes))
fun fallowPath(tubes: Array<String>, startPoint: Pair<Int, Int>) = buildSequence {
    fun moveOneStep(pos: Pair<Int, Int>, dir: MoveDirection) =
            when(dir) {
                MoveDirection.DOWN -> pos.copy(second = pos.second + 1)
                MoveDirection.UP -> pos.copy(second = pos.second - 1)
                MoveDirection.RIGHT -> pos.copy(first = pos.first + 1)
                MoveDirection.LEFT -> pos.copy(first = pos.first - 1)
                MoveDirection.STOP -> pos.copy()
            }

    var pos = startPoint
    var dir = MoveDirection.DOWN
    while(true) {
        val current = getLine(pos, tubes)
        if (current.isLetter()) yield(current)
        if (getLine(moveOneStep(pos, dir), tubes).isWhitespace())
            dir = findNewDirection(dir, pos, tubes) // change dir
        if (dir == MoveDirection.STOP) break
        pos = moveOneStep(pos, dir)
    }
}.toList()

fun getLine(pos: Pair<Int, Int>, tubes: Array<String>) = getLine(pos.first, pos.second, tubes)
fun getLine(x: Int, y: Int, tubes: Array<String>) =
        if (y >= tubes.size || y < 0) ' '
        else if (x >= tubes[y].length || x < 0) ' '
        else tubes[y][x]

enum class MoveDirection { UP, DOWN, LEFT, RIGHT, STOP }

fun findNewDirection(dir: MoveDirection, pos: Pair<Int, Int>, tubes: Array<String>) = when {
    // avoid going back
    dir != MoveDirection.UP && !getLine(pos.first, pos.second + 1, tubes).isWhitespace() -> MoveDirection.DOWN
    dir != MoveDirection.LEFT && !getLine(pos.first + 1, pos.second, tubes).isWhitespace() -> MoveDirection.RIGHT
    dir != MoveDirection.DOWN && !getLine(pos.first, pos.second - 1, tubes).isWhitespace() -> MoveDirection.UP
    dir != MoveDirection.RIGHT && !getLine(pos.first - 1, pos.second, tubes).isWhitespace() -> MoveDirection.LEFT
    else -> MoveDirection.STOP
}

fun findStartPoint(tubes: Array<String>): Pair<Int, Int> {
    tubes[0].forEachIndexed { index, c ->
        if (! c.isWhitespace()) return Pair(index, 0)
    }
    throw IllegalArgumentException("No starting point found")
}

fun parseTubes(input: String): Array<String> = input.split("\n").drop(1).dropLast(1).toTypedArray()

val day19ExampleInput = """
     |
     |  +--+
     A  |  C
 F---|----E|--+
     |  |  |  D
     +B-+  +--+
"""

val day19Input = """
                                                                                                                   |
                 +-------------------------+ +-+               +-------------+                                     |                                           +-+   +-----------------+       +-------+
                 |                         | | |               |             |                                     |                                           | |   |                 |       |       |
 +---------------|---------------------------------------------|-------------|-------------------------------------|-------+     +-----------------------------+ |   |       +-------------------+ +-+ |
 |               |                         | | |               |             |                                     |       |     |                               |   |       |         |       | | | | |
 +---------+     |               +-----------+ +---------------|-------------|---------------+           +---------|-------|-----------------------------------------|-----------------|-------+ +-+ | |
           |     |               |         |                   |             |               |           |         |       |     |                               |   |       |         |             | |
           | +-------------------|-----------------------------|-----+       |               |           |         |       |     |                               | +-----+   +---------|---------+   | |
           | |   |               |         |                   |     |       |               |           |         |       |     |                               | | |   |             |         |   | |
   +-------------|-------------------------|-------------------|-----|-------|---------------------------------------------------|---------------------------------|-|---|-------------|-------------|-+
   |       | |   |               |         |                   |     |       |               |           |         |       |     |                               | | |   |             |         |   |
   |       | |   +---------------|-----+   |                   |     |       |               |           |         |   +---|-----+             +-----------------------+ |             |         |   |
   |       | |                   |     |   |                   |     |       |               |           |         |   |   |                   |                 | | | | |             |         |   |
   |       +-+                   |     |   |           +-------|-----|-------|-------------------------------------|---|-----------------------|-----------------|---|-|-|---+         |         |   |
   |                             |     |   |           |       |     |       |               |           |         |   |   |                   |                 | | | | |   |         |         |   |
   |                         +-------------------------|-------|-----------------------------------------------------------|---------------------------------------+ +-+ |   |         |         |   |
   |                         |   |     |   |           |       |     |       |               |           |         |   |   |                   |                 |       |   |         |         |   |
   |                         |   |     |   |           |       |     |       |               |           |         |   |   |                   |                 |       |   |         |         |   |
   |                         |   |     |   |           |       |     |       |               |           |         |   |   |                   |                 |       |   |         |         |   |
   |                         |   |     +---|-----------|-----+ |     |       |               |           |         |   |   |           +-------|-----------------|-------|-----------+ |         |   |
   |                         |   |         |           |     | |     |       |               |           |         |   |   |           |       |                 |       |   |       | |         |   |
   |                         |   |         | +---------|-----|-------|---+   |               |           |         |   |   |           +---------------------------------------------|-|---------|---|-+
   |                         |   |         | |         |     | |     |   |   |               |           |         |   |   |                   |                 |       |   |       | |         |   | |
   |                         |   |         | |         |     | |     |   |   |               |           |         |   |   |               +-------------------+ |       |   |       | |         |   | |
   |                         |   |         | |         |     | |     |   |   |               |           |         |   |   |               |   |               | |       |   |       | |         |   | |
   |       +-----------------|---|-+       | |         +-----|-|-----|-------|---------------------------|---------|---------------------------|----F--------------------|-----+     | |         |   | |
   |       |                 |   | |       | |               | |     |   |   |               |           |         |   |   |               |   |               | |       |   | |     | |         |   | |
   |       |   +-+ +---------------|---------|---------------------------|---|---------------|-------------------------------------------------|-----------------|-----+ |   | |     | |         |   | |
   |       |   | | |         |   | |       | |               | |     |   |   |               |           |         |   |   |               |   |               | |     | |   | |     | |         |   | |
   |       |   | | |         |   | |       | |               | |     |   |   |               |           |         |   |   |               |   |               | |     | |   | |     | |         |   | |
   |       |   | | |         |   | |       | |               | |     |   |   |               |           |         |   |   |               |   |               | |     | |   | |     | |         |   | |
   |       |   | | |         |   | |       | |               | |     |   |   |               |           |         |   |   |               |   |               | |     | |   | |     | |         |   | |
   |       |   | | |         |   | |       | |               | |     |   |   |               |           |         |   |   |               |   |               | |     | |   | |     | |         |   | |
   | +-+   +---|-|-----+     |   | +---+   | |               | |     |   |   |               |           |         |   |   |               |   |               | |     | |   | |     +---------+ |   | |
   | | |       | | |   |     |   |     |   | |               | |     |   |   |               |           |         |   |   |               |   |               | |     | |   | |       |       | |   | |
   | | |       | | |   |     |   |     |   | |               | |     |   |   |               |           |         |   |   |               |   |               | |     | |   | |       |       | |   | |
   | | |       | | |   |     |   |     |   | |               | |     |   |   |               |           |         |   |   |               |   |               | |     | |   | |       |       | |   | |
   | | +-------|-|-----------------+   |   | |               | |     |   |   |               |           |         |   |   |               |   |               | |     | |   | |     +---+     | |   | |
   | |         | | |   |     |   | |   |   | |               | |     |   |   |               |           |         |   |   |               |   |               | |     | |   | |     | | |     | |   | |
   | |   +-------|-|---|---------|-|-----------------------------------------|---------------|-----------|---------|---|---|---------------|---|-+   +-----+   | |     | |   | |     | | |     | |   | |
   | |   |     | | |   |     |   | |   |   | |               | |     |   |   |               |           |         |   |   |               |   | |   |     |   | |     | |   | |     | | |     | |   | |
   | |   |     | | |   |     |   | |   |   | |               | |     |   |   |               |           |         |   |   |               |   | |   |     +-+ | |     | |   | |     | | |     | |   | |
   | |   |     | | |   |     |   | |   |   | |               | |     |   |   |               |           |         |   |   |               |   | |   |       | | |     | P   | |     | | |     | |   | |
   | |   |     | | |   |     |   | +---|---|-|-------------------------------|---------------|-----------|-----------------|-------------------------|-----------------|-------|-------+ |     | |   | |
   | |   |     | | |   |     |   |     |   | |               | |     |   |   |               |           |         |   |   |               |   | |   |       | | |     | |   | |     |   |     | |   | |
   | |   |     | | |   |     |   |     |   | |               | |     |   |   |               |           |         |   |   |               |   | |   |   +-+ | | |     | |   | |     |   +-----|-|-+ | |
   | |   |     | | |   |     |   |     |   | |               | |     |   |   |               |           |         |   |   |               |   | |   |   | | | | |     | |   | |     |         | | | | |
   | |   | +-----|-----------|---|---------|-|-----------------|---------|---|-------------------------------------|---|-----------------------|-|---|---|-----|---------------------|---+     | | | | |
   | |   | |   | | |   |     |   |     |   | |               | |     |   |   |               |           |         |   |   |               |   | |   |   | | | | |     | |   | |     |   |     | | | | |
   | |   | |   | | |   |     |   |     +-----------------------|-----|-----------------------+ +---------+         |   |   |               |   | |   |   | | | | |     | |   | |     |   |     | | | | |
   | |   | |   | | |   |     |   |         | |               | |     |   |   |                 |                   |   |   |               |   | |   |   | | | | |     | |   | |     |   |     | | | | |
   | |   | |   | | |   |     |   |         | |               | |     |   |   |                 |                   |   |   |               |   | |   |   | | | | |     | |   | |     |   |     | | | | |
   | |   | |   | | |   |     |   |         | |               | |     |   |   |                 |                   |   |   |               |   | |   |   | | | | |     | |   | |     |   |     | | | | |
   | |   | |   | | |   |     |   |         | |           +-----------+   |   +-----------------------------------------|-------------------|-----|---|---|-|-|---------|-----|-|-----|---|-----|---+ | |
   | |   | |   | | |   |     |   |         | |           |   | |         |                     |                   |   |   |               |   | |   |   | | | | |     | |   | |     |   |     | |   | |
   | |   | |   | | |   |     |   |         | |           |   | |         |                     |                   |   |   |               |   | |   |   | | | | |     | |   | |     |   |     | |   | |
   | |   | |   | | |   |     |   |         | |           |   | |         |                     |                   |   |   |               |   | |   |   | | | | |     | |   | |     |   |     | |   | |
   | |   | |   | | |   |     |   |   +-----+ |           |   | |         |                     +-------------------------------------------------|-----------|-|---------|-----|-----|---|-----+ |   | |
   | |   | |   | | |   |     |   |   |       |           |   | |         |                                         |   |   |               |   | |   |   | | | | |     | |   | |     |   |       |   | |
   | |   | |   | | |   |     |   |   |       |           |   | |         |                                         +---|-+ |               |   | |   |   | | | | |     | |   | |     |   |       |   | |
   | |   | |   | | |   |     |   |   |       |           |   | |         |                                             | | |               |   | |   |   | | | | |     | |   | |     |   |       |   | |
   | |   | |   | | |   |     |   |   |       |           |   | |         |                   +-----------------------------|---------------------+   |   | | | | |     | |   | |     | +-|-------|-+ | |
   | |   | |   | | |   |     |   |   |       |           |   | |         |                   |                         | | |               |   |     |   | | | | |     | |   | |     | | |       | | | |
   | |   | +-----|-|---------|---|-------+   |           |   | |         |                   |                         | | |               |   |     |   | | | | |     | |   | |     | | |       | | | |
   | |   |     | | |   |     |   |   |   |   |           |   | |         |                   |                         | | |               |   |     |   | | | | |     | |   | |     | | |       | | | |
   | |   |     | | |   |     |   | +---------|-----------|---|-----------|-------------------+                         | | |               |   |     |   | | | | |     | |   | |     | | |       | | | |
   | |   |     | | |   |     |   | | |   |   |           |   | |         |                                             | | |               |   |     |   | | | | |     | |   | |     | | |       | | | |
   | |   |     | | |   |     | +---|-|---|-------+       |   | |         |               +-------------------------------------------------|---------|-----|-|---|-----|-------+     | | |     +-----|-+
   | |   |     | | |   |     | | | | |   |   |   |       |   | |         |               |                             | | |               |   |     |   | | | | |     | |   |       | | |     | | | |
   | |   | +---|---|---------|-|-----|---|-------|-------|---|-|---------|---------------------------------------------|-|-----------------|---|---+ |   | | | | |     | |   |       | | |     | | | |
   | |   | |   | | |   |     | | | | |   |   |   |       |   | |         |               |                             | | |               |   |   | |   | | | | |     | |   |       | | |     | | | |
 +---|---|-----|---|-+ |     | | | +-|-------------------|-------------------------------|---------------+             | | |               |   +---|-|---|-|---|-|-------|---------+ | | |     | | | |
 | | |   | |   | | | | |     | | |   |   |   |   |       |   | |         |               |               |             | | |               |       | |   | | | | |     | |   |     | | | |     | | | |
 | | +-----|---|-|-|---|-----|---|---|-------|-----------|-----|---------|-------------------------------|-----------------------------------------|-|---+ | | | |     | |   |     | | | |     | | | |
 | |     | |   | | | | |     | | |   |   |   |   |       |   | |         |               |               |             | | |               |       | |     | | | |     | |   |     | | | |     | | | |
 | |     | |   | | | | |     | | |   |   |   |   |       |   | |         |               |               |             | | |               |       | |     | | | |     | |   |     | | | |     | | | |
 | |     | |   | | | | |     | | |   |   |   |   |       |   | |         |               |               |             | | |               |       | |     | | | |     | |   |     | | | |     | | | |
 | |   +---------|-|---|-----|---|-----------------------|---|-+         |               |               |             | | |               |       | |     | | | |     | |   |     | | | |     | | | |
 | |   | | |   | | | | |     | | |   |   |   |   |       |   |           |               |               |             | | |               |       | |     | | | |     | |   |     | | | |     | | | |
 | |   | | |   | | | | |     | | |   |   |   |   |       |   |           |               |               |         +-------------+         +---------|-----|-|---|-----+ |   |     | | | |     | | | |
 | |   | | |   | | | | |     | | |   |   |   |   |       |   |           |               |               |         |   | | |     |                 | |     | | | |       |   |     | | | |     | | | |
 | |   | | |   | | | | |     | | |   |   |   |   |       |   |           |   +-----+     |               |         |   | | |   +---------------------------|-+ | |       |   |     | | | |   +-|-+ | |
 | |   | | |   | | | | |     | | |   |   |   |   |       |   |           |   |     |     |               |         |   | | |   | |                 | |     |   | |       |   |     | | | |   | |   | |
 | |   | | |   | | | | |     | | |   |   |   |   |       |   |           |   |     |     | +-------------|-----------------|---|-|-----------------|-----------|-|-----+ |   |     | | | |   | |   | |
 | |   | | |   | | | | |     | | |   |   |   |   |       |   |           |   |     |     | |             |         |   | | |   | |                 | |     |   | |     | |   |     | | | |   | |   | |
 | |   | +-|---|-|-----|-----|---|---|---|---|-------------------------------------|-----|-|-----------------------|-----|-|-----|-------------+ +-+ |   +-|---|-+     | |   |     | | | |   | |   | |
 | |   |   |   | | | | |     | | |   |   |   |   |       |   |           |   |     |     | |             |         |   | | |   | |             | |   |   | |   |       | |   |     | | | |   | |   | |
 | |   +---+   | | | | |     | | |   |   |   |   |       |   |           |   |     |     | |             |         |   | | |   | |           +---|-T |   | |   |       | |   |     | | | |   | |   | |
 | |           | | | | |     | | |   |   |   |   |       |   |           |   |     |     | |             |         |   | | |   | |           | | |   |   | |   |       | |   |     | | | |   | |   | |
 | |           | | | | |     | | |   +---|-------|-+     |   | +---------|-------------------------------|-------------|-|-----|-|-----+     | | | +-----------|-------+ |   |     | | | |   | | +-|---+
 | |           | | | | |     | | |       |   |   | |     |   | |         |   |     |     | |             |         |   | | |   | |     |     | | | | |   | |   |         |   |     | | | |   | | | | | |
 | |   +-+     | | | | |     | | |       |   |   | |     |   | |         |   |     +-------|-----------------------|-----|-------|-----|-----|-|-|-|-|---|-----|---------------------|---|-+ | | | | | |
 | |   | |     | | | | |     | | |       |   |   | |     |   | |         |   |           | |             |         |   | | |   | |     |     | | | | |   | |   |         |   |     | | | | | | | | | | |
 | |   | |     | | | | |     | | |       |   |   | |     |   | |         |   |           | |             |         |   | | |   | |     |     | | | | | +-|-----|-------------|-----|---|-|-+ | | | | | |
 | |   | |     | | | | |     | | |       |   |   | |     |   | |         |   |           | |             |         |   | | |   | |     |     | | | | | | | |   |         |   |     | | | |   | | | | | |
 | |   | |     | | | | |     | | |       |   |   | |     |   | |         |   | +---------|-|-----------------------|---|---|---|-------|-------|-|-----+ | |   |       +-----|-----|-|-|-|-+ | | | | | |
 | |   | |     | | | | |     | | |       |   |   | |     |   | |         |   | |         | |             |         |   | | |   | |     |     | | | | |   | |   |       | |   |     | | | | | | | | | | |
 +-+   | | +---|-----|-|-------|-|-------|-------|-----------|---------------------------------------------------------|-|-|-----|-+   |     | | | | |   | |   |       | |   |     | | | | | | | | | | |
       | | |   | | | | |     | | |       |   |   | |     |   | |         |   | |         | |             |         |   | | |   | | |   |     | | | | |   | |   |       | |   |     | | | | | | | | | | |
   +-------|---|-------------|-|---------|---+   | |     |   | |         |   | |         | |     +---------------------|-|-|-------|---------|-+ | | |   | | +-|-------+ |   |     | +---------|-|-----+
   |   | | |   | | | | |     | | |       |       | |     |   | |         |   | |         | |     |       |         |   | | |   | | |   |     |   | | |   | | | |         |   |     |   | | | | | | | |
 +-----|---------|-|-|-------|---|-----------------------|-------------+ |   | |         | |     |       |         |   | | |   | | |   |     |   | +-------|-|-|-------------------|---|-|-|-----+ | |
 | |   | | |   | | | | |     | | |       |       | |     |   | |       | |   | |         | |     |       |         |   | | |   | | |   |     |   |   |   | | | |         |   |     |   | | | | |   | |
 | +-----|-|-+ | | | | |     | | |       |   +---|-|---------|-|-------|-----|---------------------------|---------+   | | |   | | |   |     | +-|---|-----|-------+     |   |     | +-|-|-------+ | |
 |     | Y | | | | | | |     | | |       |   |   | |     |   | |       | |   | |         | |     |       |             | | |   | | |   |     | | |   |   | | | |   |     |   |     | | | | | | | | | |
 |     | | | | | | | | |     | | |       |   |   | |     | +-------------|-----|-----------|-----|-------|---------+   | | |   | +-|-------------|-------|-|-|-|---|---------------|---|---|-|-|---|-|-+
 |     | | | | | | | | |     | | |       |   |   | |     | | | |       | |   | |         | |     |       |         |   | | |   |   |   |     | | |   |   | | | |   |     |   |     | | | | | | | | | | |
 |     | | | | | | | | |     | | |       |   |   | |     | | | |       | |   +-|-----------------------------------|---|---|---|-------|-------|---------|-|---|-------------|-----|-+ | | | | | | | | |
 |     | | | | | | | | |     | | |       |   |   | |     | | | |       | |     |         | |     |       |         |   | | |   |   |   |     | | |   |   | | | |   |     |   |     |   | | | | | | | | |
 |     | | | | | | | | |     | +-|-------|---------|-----|-|-|-|-------|-----------------|-------|-----------------|-------|-----+ |   |     | | |   |   | | | |   |     |   |     | +---|---|-|-+ | | |
 |     | | | | | | | | |     |   |       |   |   | |     | | | |       | |     |         | |     |       |         |   | | |   | | |   |     | | |   |   | | | |   |     |   |     | | | | | | |   | | |
 |     | | | +-----|---|-------+ |     +-+   |   | |     | | | |     +---|-----|-------------------------------+   |   | | |   | | |   |     | +---+ |   | | +-|-------------|-----|---|-|---|-|---|-|-+
 |     | | |   | | | | |     | | |     |     |   | |     | | | |     | | |     |         | |     |       |     |   |   | | |   | | |   |     |   | | |   | |   |   |     |   |     | | | | | | |   | |
 |     | | | +---|-----|-------|-|-----------+   | |     | | | |     | | |     |         | |     |       +---------|-----|-----|---|---------------|-----|-|---|---|---------|-----|-----|-----|-------+
 |     | | Z | | | | | |     | | |     |         | |     | | | |     | | |     |         | |     |             |   |   | | |   | | |   |     |   | | |   | |   |   |     |   |     | | | | | | |   | | |
 |     | | | | | | | | |     | | |     |         | |     | | +---------|-|-----|---------|-|-----|-------+     |   |   | | |   | | |   |     |   | | |   +-|-------|-----|---------|-+ | | | | |   | | |
 |     | | | | | | | | |     | | |     |         | |     | |   |     | | |     |         | |     |       |     |   |   | | |   | | |   |     |   | | |     |   |   |     |   |     |   | | | | |   | | |
 |     | | | | | | | | |     | +-|-----------------|-----|-|--------M--+ |     |         | |     |       |     |   |   | | |   | | |   |     |   | | |     |   |   |     |   |     |   | | | | |   | | |
 |     | | | | | | | | |     |   |     |         | |     | |   |     |   |     |         | |     |       |     |   |   | | |   | | |   |     |   | | |     |   |   |     |   |     |   | | | | |   | | |
 |     | | | | | | | | |     |   +-----|---------|-----------------------|-----|-----------------|---------+   |   |   | | |   | | |   |     |   | | |     |   |   |     |   |     |   | | +-|-|-+ | | |
 |     | | | | | | | | |     |         |         | |     | |   |     |   |     |         | |     |       | |   |   |   | | |   | | |   |     |   | | |     |   |   |     |   |     |   | |   | | | | | |
 |     | | | | | | | | |   +---------------------|-------|---------------|-----|-------+ | |     |       | |   |   |   | | |   | | |   |     |   | | |     |   |   |     |   |     |   | |   | | | | | |
 |     | | | | | | | | |   | |         |         | |     | |   |     |   |     |       | | |     |       | |   |   |   | | |   | | |   |     |   | | |     |   |   |     |   |     |   | |   | | | | | |
 |     | | | | | | | | +-------+       |         | |     | |   |     |   |     |       | +---------------------|---|---|-------|-|-----|-----|---|-|-|---+ |   |   |     |   |     |   | |   | | | | | |
 |     | | | | | | | |     | | |       |         | |     | |   |     |   |     |       |   |     |       | |   |   |   | | |   | | |   |     |   | | |   | |   |   |     |   |     |   | |   | | | | | |
 |   +-----|---------+ +---|---|-----------------|-------|-----|---------|-----------------|-------------|-----|-----------+   | | +---|---------|-|-|---|-|---|---|---------------+   | |   | | | | | |
 |   | | | | | | | |   |   | | |       |         | |     | |   |     |   |     |       |   |     |       | |   |   |   | |     | |     |     |   | | |   | |   |   |     |   |         | |   | | | | | |
 |   | | | | | | | |   |   | | |       |         | |     | |   |     |   +-----------------+     |       +-|-------|-------------------+     |   | | |   | |   |   |     |   |         | |   | | | | | |
 |   | | | | | | | |   |   | | |       |         | |     | |   |     |         |       |         |         |   |   |   | |     | |           |   | | |   | |   |   |     |   |         | |   | | | | | |
 | +-|---------|-----------|---|-------------------|-----|-----|-----|-----------------|---------|-------+ |   |   |   | |     | |           |   | | |   | |   |   |     |   |         | |   | | | | | |
 | | | | | | | | | |   |   | | |       |         | |     | |   |     |         |       |         |       | |   |   |   | |     | |           |   | | |   | |   |   |     |   |         | |   | | | | | |
 | | | | | | | | | |   |   | | |       |         | |   +-|-----|-----|---------------------------|---------|-------------------|-------------------|-|-+ | |   |   |     |   |         | |   | | | | | |
 | | | | | | | | | |   |   | | |       |         | |   | | |   |     |         |       |         |       | |   |   |   | |     | |           |   | | | | | |   |   |     |   |         | |   | | | | | |
 +---|-|-------|-|-----+   | | |       |         | |   | | |   +---------------|-------------------------------|---|-----------|-------------|---|-----|-|-+   |   |     |   |         | |   | | | | | |
   | | | | | | | | |       | | |       |         | |   | | |         |         |       |         |       | |   |   |   | |     | |           |   | | | | |     |   |     |   |         | |   | | | | | |
   +-|-|-----|---|-----+   | | | +-----|---------------|-----------------------|-----------------|-------|---------|-------------------------|-------|---|-----|---------|---|---+     | |   | | | | | |
     | | | | | | | |   |   | | | |     |         | |   | | |         |         |       |         |       | |   |   |   | |     | |           |   | | | | |     |   |     |   |   |     | |   | | | | | |
     | | | | | | | |   |   | | +-|---------------|-----+ | |         |         |       |         |       | |   |   |   | |     | |           |   +-|---|-|-+   |   |     |   |   +---+ | |   | | | | | |
     | | | | | | | |   |   | |   |     |         | |     | |         |         |       |         |       | |   |   |   | |     | |           |     | | | | |   |   |     |   |       | | |   | | | | | |
   +---------|---|-|-------+ |   |     |         | |     | |         |         |       |         |       +-|---|---|---|-------|-------------|---+ | | +-|-+   |   |     |   |       | | |   | | | | | |
   | | | | | | | | |   |     |   |     |         | |     | |         |         |       |         |         |   |   |   | |     | |           |   | | |   |     |   |     |   |       | | |   | | | | | |
   | | | | | | | | |   |     |   |     |         | |     | |         |         |       |         |         |   |   |   | |     | |           |   | | |   |     |   |     |   |       | | |   | | | | | |
   | | | | | | | | |   |     |   |     |         | |     | |         |         |       |         |         |   |   |   | |     | |           |   | | |   |     |   |     |   |       | | |   | | | | | |
   | | | | | | | | |   |     |   |     | +-------|-|-------|---------|-----------------|---------|---------|---|---|-----|-------------------|-------|---------|---|-----|---+       | | |   | | | | | |
   | | | | | | | | |   |     |   |     | |       | |     | |         |         |       |         |         |   |   |   | |     | |           |   | | |   |     |   |     |           | | |   | | | | | |
   | | | | | | | | |   |     |   |     | |       | |     | |         |         |       |         |         |   |   |   | |     | |           |   | | |   |     |   |     |           | | |   | | | | | |
   | | | | | | | | |   |     |   |     | |       | |     | |         |         |       |         |         |   |   |   | |     | |           |   | | |   |     |   |     |           | | |   | | | | | |
   | | | | | | | | |   |     |   |     | |       | |     | |         |         |       |         |         |   |   +-+ | |     | |     +---+ |   | +-|-------------|-----------------|---|-----|-|-+ | |
   | | | | | | | | |   |     |   |     | |       | |     | |         |         |       |         |         |   |     | | |     | |     |   | |   |   |   |     |   |     |           | | |   | | |   | |
   | | | | | | | | |   |     |   |     | |       | |     | |         |         |       |         |         |   |     | | |     | |     |   | |   |   |   |     |   |     +-----------|-------|-+ |   | |
   | | | | | | | | |   |     |   |     | |       | |     | |         |         |       |         |         |   |     | | |     | |     |   | |   |   |   |     |   |                 | | |   |   |   B |
   | | | | | +-|-------|-----|---------|-+       | |     | |         |   +-----|-------|---------|---------|---|-----|-|-|-----|-----------------|-------------|---------+           | | |   |   |   | |
   | | | | |   | | |   |     |   |     |         | |     | |         |   |     |       |         |         |   |     | | |     | |     |   | |   |   |   |     |   |     |           | | |   |   |   | |
   | | | | |   | | |   |     |   |     | +-------+ |     | |         |   +-------------|-------------------|---+     | | |     | |     |   | |   |   |   |     |   |     |         +-|---|-+ |   |   | |
   | | | | |   | | |   |     |   |     | |         |     | |         |         |       |         |         |         | | |     | |     |   | |   |   |   |     |   |     |         | | | | | |   |   | |
   | | | +-|---+ +-----|-----|---|-----|-----------+     | |         |         |       |         |       +------H------|-----+ | |     |   | |   |   |   |     |   |     |         | | | | | |   |   | |
   | | |   |       |   |     |   |     | |               | |         |         |       |         |       | |         | | |   | | |     |   | |   |   |   |     |   |     |         | | | | | |   |   | |
 +-------------+   |   |     |   |     | |               | |         |         |       |         |       | |         | | |   | | |     |   | |   +---|---------|---+     |         | | | | | |   |   | |
 | | | |   |   |   |   |     |   |     | |               | |         |         |       |         |       | |         | | |   | | |     |   | |       A   |     |         |         | | | | | |   |   | |
 +-------+ +-------|-------+ |   |     | |               | |         |         |       |         +---------|---------|-|-----|-|-|---------|-------------------+ +-----+ |         | | | | | |   |   | |
   | | | |     |   |   |   | |   |     | |               | |         |         |       |                 | |         | | |   | | |     |   | |       |   |       |     | |         | | | | | |   |   | |
   | | | |     |   |   |   | |   | +-----------------------|-----------------------+   |                 +-+         | | |   | | |     |   | |       |   |       |     | |         | | | | | |   |   | |
   | | | |     |   |   |   | |   | |   | |               | |         |         |   |   |                             | | |   | | |     |   | |       |   |       |     | |         | | | | | |   |   | |
 +-----+ |     |   |   |   | |   | |   | |               | |         |         |   |   |                             | | |   | | |     |   | |   +-------|-----+ |     | |         | | | | | |   |   | |
 | | |   |     |   |   |   | |   | |   | |               | |         |         |   |   |                             | | |   | | |     |   | |   |   |   |     | |     | |         | | | | | |   |   | |
 | | +---|-----|-----------------|-|-----|-------------------------------------|-------+                             | +-----+ | |     |   | |   +---------------------------------|-|---|-+ |   |   | |
 | |     |     |   |   |   | |   | |   | |               | |         |         |   |                                 |   |     | |     |   | |       |   |     | |     | |         | | | |   |   |   | |
 | | +---------|-------|-----------|-----------------------+         +---------|-------------------------------------|---|-----|-------------|-------|---|-----|-|-------|-----------|-+ |   |   |   | |
 | | |   |     |   |   |   | |   | |   | |               |                     |   |                                 |   |     | |     |   | |       |   |     | |     | |         | |   |   |   |   | |
 | | +-+ | +---|-------|---|-|---|-----|-|-----------------------------------------|---------------------------------|---------|-------+   | |       |   +-----+ |     | |         | |   |   |   |   | |
 | |   | | |   |   |   |   | |   | |   | |               |                     |   |                                 |   |     | |         | |       |           |     | |         | |   |   |   |   | |
 | | +-+ | |   +---|-------|-|---|-|---|-+     +-----------+                   |   |                                 |   |     | |         | |       |           |     | |         | |   |   |   |   +-+
 | | |   | |       |   |   | |   | |   |       |         | |                   |   |                                 |   |     | |         | |       |           |     | |         | |   |   |   |
 +---|---|-+       |   |   | +---|-----|-------|---------|-------------------------|-------------------------------------------|-------------|-------|-----------------|-------------+   |   |   |
   | |   |         |   |   |     | |   |       |         | |                   |   |                                 |   |     | |         | |       |           |     | |         |     |   |   |
   | +---+         |   |   |     | |   |       |         | |                   |   +---------------------------------|---|-------|---+     | | +-------------------------|---------------+   |   |
   |               |   |   |     | |   |       |         | |                   |                                     |   |     | |   |     | | |     |           |     | |         |         |   |
   |               |   |   |     | |   |       |         | |                   |                                     |   |     | |   |     | | |     +-----------------+ +---------|-----------------+
   |               |   |   |     | |   |       |         | |                   |                                     |   |     | |   |     | | |                 |                 |         |   |   |
   |               |   |   |     | |   |       |         | |                   |                                     +---|-----|-|---|-----|-----------+         |                 |         |   |   |
   |               |   |   |     | |   |       |         | |                   |                                         |     | |   |     | | |       |         |                 |         |   |   |
   |               |   |   |     +-----|-------|-----------|-------------------|-----------------------------------------+     | +---|-----+ | |       |         |                 |         |   |   |
   |               |   |   |       |   |       |         | |                   |                                               |     |       | |       |         |                 |         |   |   |
   |               |   |   |       |   +-----------------|-|-------------------------------------------+       +---------------|-----+       | |       |         |                 |     +-------+   |
   |               |   |   |       |           |         | |                   |                       |       |               |             | |       |         |                 |     |   |       |
   |             +-+   +---+       +-----------+         | |                   |                       |       +---------------|---------------------------------|-----------------+ +---|---------+ |
   |             |                                       | |                   |                       |                       |             | |       |         |                   |   |   |     | |
 +-+             | +-------------------------------------|-+                   |                       +-------------------------------------|-------------------------------------------------------+
 |               | |                                     |                     |                                               |             | |       |         |                   |   |   |     |
 +-----------------|-------------------------------------|---------------------|-------------------------------------------------------------|-|-----------------|-----+             +---+   |   +-|-+
                 | |                                     |                     |                                               |             | |       |         |     |                     |   | | |
         +-------+ |                                     |                     +---------------------------------------+     +---------------+ |       | +-------------------------------+   |   +-----+
         |         |                                     |                                                             |     | |               |       | |       |     |                 |   |     | | |
         |         |                                     |                                       +---------------------|-------+               |       +-|-------|-------+               +---|-----|-+ |
         |         |                                     |                                       |                     |     |                 |         |       |     | |                   |     |   |
 +-------+         |                             +-------|-------------------------------------------------------------------------------------|---------|-------|-----|-+                   |     |   |
 |                 |                             |       |                                       |                     |     |                 |         |       |     |                     |     |   |
 +-------+         +-----------------------------+       +---------------------------------------|---------------------------|-----------------|---------+       |     +---------------------+   +-+ +-+
         |                                                                                       |                     |     |                 |                 |                               |   |
         +---------------------------------------------------------------------------------------+                     +-----+                 +-----------------+                               +---+

"""